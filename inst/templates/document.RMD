# Analysis overview


# setup and environment

```{r, environment}

#turn off scientific notation and prevent strings being read as factors
options(scipen = 10E6, stringsAsFactors = F)

# helpful functions
writeClipboard2 = function(x) writeClipboard(charToRaw(paste0(x, ' ')))
reslash<- function(x=NA, slash=c("back","forward")){
  if(is.na(x)) x = readClipboard()
  if(slash[1]=="back") path <- shQuote(gsub("/","\\\\",gsub("\\", "\\\\", x, fixed = TRUE), fixed = TRUE))
  if(slash[1]=="forward") path <- shQuote(gsub("\\", "/", x, fixed = TRUE))
  writeClipboard2(path)
  return(path)
}
bs=function(x=NA){reslash(x,slash="back")}
fs=function(x=NA){reslash(x,slash="forward")}
nv=nmsVec=function(x){x=paste("c('",paste(names(x),collapse="','"),"')",sep=""); writeClipboard2(x);return(x)}


```

## examples

```{r}

#load data
if(F){ 
	
  library(RSQLite)
  library(DBI)
	library(sf)
	
	#create versioned files
	this_version = "v1_20220818"
	file_csv = file.path("c:/temp",paste0("some_plots_",this_version,".csv"))
	file_rds = file.path("c:/temp",paste0("some_plots_",this_version,".RDS"))
	file_db = file.path("c:/temp",paste0("some_plots_",this_version,".db") )
	file_shp = file.path("c:/temp",paste0("some_plots_",this_version,".shp") )
		
		aoi_boundary_HARV <- st_read(
  "data/NEON-DS-Site-Layout-Files/HARV/HarClip_UTMZ18.shp")
	
	#simulate / write small simulated table of data
	
		#simulate
		test_dat = data.frame(plot=1:5,some_x=rnorm(5), some_y=rnorm(5))
		test_dat_sf = st_as_sf(test_dat, coords=c("some_x","some_y"))
		
		#write csv
		write.csv(test_dat,  file_csv )
		
		#save R binary format
		saveRDS(test_dat, file_rds)
		
		#save to database
	  con_this = dbConnect(RSQLite::SQLite(), file_db )
	  	dbWriteTable( con_this , "pldat" , test_dat , overwrite = T )
	  dbDisconnect(con_this)  
	
	  #write to shapefile
	  st_write(test_dat_sf, file_shp, "layer1")
	  
	#read data
	dat_csv = read.csv(file_csv)
	dat_rds = readRDS(file_rds)
	
	#load sqlite data
  con_this = dbConnect(RSQLite::SQLite(), file_db )
  	dat_db = dbReadTable(con_this ,"pldat" )
  dbDisconnect(con_this)  
  
  #load spatial data
  dat_sf = st_read(file_shp)
  
}

#parallel processing example
if(F){
  library(foreach)
  library(parallel)
  library(doParallel)
  
  #set up sock cluster and set output message file directory
  #then register with doParallel
  if( !"cl_this" %in% ls() | F){
    cl_this = makeCluster(45,outfile="c:/temp/this_out.txt")
    registerDoParallel(cl_this)
  }
  
  #constants / function in global environment
  mult = 5
  fn_test = function(x)sqrt(sum(abs(x)))
  
  #run parallel and show that global environment loads to threads (careful)
  res = foreach(j = 1:5000, .combine=c) %dopar% {  
    
    #do some work
    fn_test( mult*rnorm(500) )
    
  }
  
  #clean up threads
  if(T){ try(stopCluster(cl_this)); try(rm(cl_this));try(closeAllConnections()) ; gc()  }

  
}


```

## set up parallel processing

```{r, eval=FALSE}




```

## 

```{r, eval=FALSE}

```

## 

```{r, eval=FALSE}

```

## 

```{r, eval=FALSE}

```


## 

```{r, eval=FALSE}

```

## 

```{r, eval=FALSE}

```

## 

```{r, eval=FALSE}

```
