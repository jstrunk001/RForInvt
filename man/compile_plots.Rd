% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/compile_plots.R
\name{compile_plots}
\alias{compile_plots}
\alias{plot_wtsum}
\alias{plot_wtmn}
\alias{spp_y_plot}
\title{Compile tree data by plot}
\usage{
compile_plots(
  cl = NA,
  df_tree = list(NA, data.frame(PLT_CN = 1, year = 2020, dbh = NA, spcd = NA, ac =
    0.1))[[1]],
  df_plot = list(NA, data.frame(PLT_CN = c(1, 2), PLOT = 1, YEAR = 2020, STATE = 1,
    COUNTY = 1, PROJECT = "Test"))[[1]],
  tree_nms = list(plot_ids = c("PLOT", "YEAR"), tree_ids = c("tr_cn"), dbh = "DIA", ht =
    "HT", spcd = "SPCD", tr_wt = "TPA"),
  plot_nms = list(plot_ids = c("STATE", "COUNTY", "PROJECT", "PLOT", "YEAR"), plt_wt =
    NA),
  tree_filter = c(NA, "select * from df_tree where dbh > 2 "),
  plot_filter = c(NA,
    "select * from df_plot where YEAR = 2018 and STATE = 'WA' and CONDITION = 1"),
  dir_out = file.path("c:/temp/RSForInvt/Compile", format(Sys.Date())),
  nm_out = "compile_plots",
  sql_tbl = "plot_metrics",
  append = T,
  fns_compute = list(plot_wtmn, plot_wtsum),
  return = F,
  do_debug = F,
  nclus = 4,
  ...
)

plot_wtsum(df_tree, tree_nms, sum_nms, ...)

plot_wtmn(df_tree, tree_nms, ...)

spp_y_plot(df_tree, tree_nms, n_dom_spp = 3, spp_y, ...)
}
\arguments{
\item{df_tree}{data frame of tree records}

\item{df_plot}{data frame of plot records}

\item{tree_nms}{map expected tree column names onto df_tree. These are the minimum expected names: c( plot_ids = "?", tr_ids = c("?","?") , dbh = "?" , ht = "?" , spcd = "?" , tr_wt = "?"). Feel free to provide others used by custom functions.}

\item{plot_nms}{map expected plot column names onto df_plot. These are the minimum expected names: c( plot_ids = c("?","?"), plt_wt = c(NA,"?")[1] ). Feel free to provide others used by custom functions.}

\item{tree_filter}{sqldf string to filter out trees}

\item{plot_filter}{sqldf string to filter out plots}

\item{dir_out}{where to write results of plot level compilation}

\item{fns_compute}{list of optional functions to compute plot level attributes.
Optional functions must accept "df_tree" and "..." arguments and generally also (typically) accept "tree_nms"
argument, e.g.,
\cr
\cr
     >fn_ba_ac = function(df_tree, tree_nms, ...){ sum(df_tree[,tree_nms["ba_ac"]]) }
\cr
\cr
This example also uses a custom value "ba_ac" value in the tree_nms argument, e.g.,
\cr
\cr
     >tree_nms = c( ba_ac = "BA_AC") )
\cr
\cr
 where "BA_AC" is presumably equal to ba_tree*TPA_tree ...}

\item{return}{return compiled data}

\item{do_debug}{stop and debug function}

\item{nclus}{if nclus > 1 then nclus parallel nodes are split off to process in parallel}

\item{...}{additional arguments provided to fns_compute e.g textString="hello" argument in silly function someFun = function(tl,tlNms,textString){data.frame(note=textString)}}

\item{sum_nms}{<...> argument passed to optional plot_wtsum function,  passed generically by compile_plots through '...'}

\item{n_dom_spp}{<...>  argument passed to optional spp_y_plot function,  passed generically by compile_plots through '...'}

\item{spp_y}{<...>  argument passed to optional spp_y_plot function,  passed generically by compile_plots through '...'}
}
\value{
NULL (return=F) or a data.frame of plot attributes (return=T)
}
\description{
Supply data.frame of tree data with plot ids and a data.frame of plot records. The function works by iterating through the tree
 data plot by plot. The compile_plots() function accepts a list of functions which compute attributes. Several example functions
 are provided, but they are probably not sufficient for operational usage. Hopefully more will be added over time. This function
 is meant to work hand in hand with compile_trees() but is still a work in progress.
}
\details{
This program is free software but it is provided WITHOUT WARRANTY
 and with ABSOLUTELY NO GUARANTEE of fitness or functionality for any purpose;
 you can redistribute it and/or modify it under the terms of the GNU
 General Public License as published by the Free Software Foundation;
 either version 2 of the License, or (at your option) any later version.

\cr
Revision History
\tabular{ll}{
1.0 \tab 6/12/2020 Created \cr
1.1 \tab 8/23/2024 Modify checks on data.frame inputs to be more generic (e.g., allow tibbles) \cr
1.1 \tab 8/23/2024 Add more debug checks \cr
}
}
\examples{

  #build fake tree list
  set.seed=111
  nfake=50
  dbh_fk = 10*abs(rnorm(nfake))
  df_fake = data.frame(
    pltId = sample((1:7),nfake,replace=T)
    ,trid=1:50
    ,db= dbh_fk
    ,ht=75*dbh_fk + rnorm(nfake)*10
    ,spp = sample(c("df","wh","cw","ra") , nfake , T)
    ,acres = 0.1
    ,trees = round(1+ abs(rnorm(nfake)/3))

  )

  #compute tree level attributes for fake tree list
  test_tl =
    compile_trees(
      df_fake

      #arguments to fn_compute functions
      ,tr_id = "trid"
      ,spp_nm = "spp"
      ,db_nm = "db"
      ,htNm = "ht"
      ,dbcl_nm = "dbcl"
      ,dbcl = c(seq(0,32,4),50,1000)
      ,dbcl_y = c("ba_ft")
      ,spp_y = c("ba_ft")
      ,spp_dbcl_y = c("ba_ft")
      ,acres_nm = "acres"
      ,ntrees_nm = NA

      #optional functions to run against tree data
      #must accept ...
      ,fn_compute =
        list(
          tpa
          ,ba_ft
          ,dbcl
          ,dbcl_y
          ,spp_y
          ,dbcl_spp_y
        )

    )

  testTL


  #compute plot level attributes from fake tree list
  res_pl =   compile_plots(

    df_tree = testTL
    ,tree_nms = c(plot_ids = c("pltId") , tr_ids = c("trid") , dbh = "db" , ht = "ht" , spcd = "spp" , tr_wt = "TPA" )
    ,dir_out= file.path("c:/temp/RSForInvt/Compile",format(Sys.Date()))
    ,fns_compute = list(
      plot_wtmn
      ,plot_wtsum
    )

    ,return = T
    ,do_debug = F

    ,nclus = 1

    #' arguments to custom functions - in this case plot_wtsum
    ,sum_nms = c("TPA",grep("^ba",names(testTL),value=T))

  )




}
\seealso{
\code{\link{compile_trees}}\cr \code{\link{parLapplyLB}}\cr
}
\author{
Jacob Strunk <someone@somewhere.com>
}
